<%- include("./partials/header.ejs")%>

    <div class="inbox-main">
      <div class="search">
        <input type="text" placeholder="Search" />
      </div>

      <div class="msg-head">
        <h2 id="msg-head"></h2>
        <img src="./images/trash.png" alt="Delete" />
      </div>

      <div class="dp-list">

        <% if(conversations && conversations.length===0){ %>
        <div class="no-conversation">
          <img src="./images/no-conversation (1).svg" alt="No conversation">
        </div>
        <% }else{ %>
        <% conversations.forEach(function(conversation){ %>
        <% if(conversation.creator.id==loggedInUser.id){ %>

        <!-- <div class="dp active">
          <img src="./images/user1.png" alt="Asad" />
          <div class="title">
            <div class="name">
              <h4>M.A. Asad</h4>
              <p>Mar 14</p>
            </div>
            <p class="msg">This is message</p>
          </div>
        </div> -->

        <div class="dp" onclick="getMessages('<%= conversation._id %>')">
          <% if(conversation.participant.avatar){ %>
          <img src="<%= conversation.participant.avatar %>" alt="<%= conversation.participant.name %>" />
          <% }else{ %>
          <img src="./images/nophoto.png" alt="<%= conversation.participant.name %>" />
          <% } %>

          <div class="title">
            <div class="name">
              <h4><%= conversation.participant.name %></h4>
              <p><%= moment(conversation.lastUpdated).fromNow() %></p>
            </div>
            <p class="msg">Click to see messages</p>
          </div>
        </div>

        <% }else{ %>

          <div class="dp" onclick="getMessages('<%= conversation._id %>')">
            <% if(conversation.creator.avatar){ %>
            <img src="./uploads/avatars/<%= conversation.creator.avatar %>" alt="<%= conversation.creator.name %>" />
            <% }else{ %>
            <img src="./images/nophoto.png" alt="<%= conversation.creator.name %>" />
            <% } %>
  
            <div class="title">
              <div class="name">
                <h4><%= conversation.creator.name %></h4>
                <p><%= moment(conversation.lastUpdated).fromNow() %></p>
              </div>
              <p class="msg">Click to see messages</p>
            </div>
          </div>

        <% } %>
          <% }) %>
          <% } %>


      </div>

      <div class="msg-body">
        <div class="no-message">
          <h2>Select a conversation</h2>
        </div>

        <!-- <div class=" message-box your-msg">
          <div class="message">See you later</div>
          <div class="date">Mar 14</div>
        </div>

          <div class="others-msg">
            <img src="./images/user1.png" alt="" />
            <div class="message-box">
              <div class="message">Ok bye</div>
              <div class="date">Mar 14</div>
            </div>
          </div> -->

        </div>

      <div class="nothing">
        <a onclick="openModal()">+</a>
      </div>

      <div class="new-msg">
        
        <form id="msg-form">
          <label for="attachment"><img src="./images/attachment.png" alt="Files" /></label>
          <input type="file" multiple name="attachment" class="hide" id="attachment">
          <input type="text" name="message" placeholder="Type a message" />
        </form>
      </div>
    </div>
    <%- include("./partials/inboxModal.ejs") %>

    <script>
    const form = document.getElementById("msg-form")
    const msgHead = document.getElementById("msg-head")
    const msgBody = document.querySelector(".msg-body")

      
    // Get messages
      async function getMessages(conversationId){

        const response = await fetch(`/inbox/messages/${conversationId}`)

        const result = await response.json()
        const {participant,loggedInUser,data} = result;


        if(data.messages&&data.messages.length>0){
          let allmessages = '';
          data.messages.forEach(message => {
            
            const senderAvatar = message.sender.avatar ? `<img src="../uploads/avatars/${message.sender.avatar}"/>` : `<img src="../images/nophoto.png"/>`
            const showAvatar = message.sender.id == loggedInUser.id? '' : senderAvatar;
            const messageClass = message.sender.id == loggedInUser.id? `your-msg` : `others-msg`;

            let showAttachment;
            if(message.attachment&&message.attachment.length>0){
              showAttachment = `<div class="attachment">`
                message.attachment.forEach(element=>{
                  showAttachment+=`<img src="../uploads/attachments/${element}"/>`
                })
                showAttachment+= `</div>`
            }

            let oneMessage = `
          <div class="${messageClass}">
            ${showAvatar}
            <div class="message-box">
              <div class="message">${message.text}${showAttachment?showAttachment:''}</div>
              <div class="date">${moment(message.time).fromNow()}</div>
              
            </div>
          </div>`

          allmessages+=oneMessage;
          });

          msgBody.innerHTML = allmessages;

        }

        if(!result.errors&&result.participant){
          msgHead.innerText=participant.name
          form.style.visibility ="visible"
        }else{

          const messageGetFailureToast = Toastify({
              text:result.errors.common.msg,
              duration:1500
            })
            messageGetFailureToast.showToast();
        }

        // Send message of form 
        form.onsubmit = async function (e){
          e.preventDefault();
  
          
          const formData = new FormData(form);
          formData.append('receiverId', participant.id);
          formData.append('receiverName', participant.name);
          formData.append('avatar', participant.avatar || '');
          formData.append('conversationId', conversationId);

  
          let response = await fetch("/inbox/message", {
          method: "POST",
          body:formData
        });
  
          const result = await response.json()


          if(!result.errors&&result.data){
            const messageSentToast = Toastify({
              text:result.message,
              duration:1000
            })
            messageSentToast.showToast()
          }else{
            const messageSendFailureToast = Toastify({
              text:result.errors.common.msg,
              duration:1500
            })
            messageSendFailureToast.showToast();
          }
        }
      }
  
    </script>
  </body>
</html>
